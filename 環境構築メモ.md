<!-- omit in toc -->
# 環境構築メモ

WSL2 × Docker × MSSQL 環境の構築メモ。
以下の環境・アプリケーションをインストールして連携させるのがゴール。

- WSL2（Ubuntu）
- Docker と Docker Compose
- MSSQL with Docker コンテナ
- Azure Data Studio

自分用に作ったので、インストールや動作に関して責任は取れません。

## 1. 必要な環境

- OS: Windows 10 バージョン 2004 以降 (ビルド 19041 以降) または Windows 11
  - `wsl` コマンド、`winget` コマンドの実行に必要なため。
- メモリ: 2GB 以上
  - SQL Server の Docker Image が 2GB 以上必要ぽかった。  
  WSL2 のメモリ制限を 1GB に設定していたらコンテナが起動できず、ログを確認するとメモリ不足で落ちてたっぽかった。制限する場合は注意。
- 空き容量: 要確認

## 2. WSL2（Ubuntu）

仮想の Linux 環境を Windows 10 上に構築するすごいやつ。
本手順では Ubuntu をインストールする。

少し前までは色々と設定を行わないといけなかったんだけど、
最近はコマンド一発でインストールできるようになった（すごい）。

### 2.1. WSL2 のインストール

wsl コマンドを使ってインストールしていく。

1. PowerShell を管理者権限で起動する。
2. 下記のコマンドを入力して送信する。

    ```shell
    wsl --install -d Ubuntu
    ```

3. インストールが開始するので、処理が完了するまで待つ。
4. 処理が完了したら、スタートメニューで「Ubuntu」と入力する。
5. スタートメニューに Ubuntu が表示されていれば一旦インストール完了。次の工程へ。

### 2.2. Ubuntu 環境の初期設定

インストールした Ubuntu を立ち上げて、初期設定を行っていく。

1. スタートメニューから Ubuntu をクリックして起動する。
   1. ここでもしエラーが出た場合、[MS公式](https://docs.microsoft.com/ja-jp/windows/wsl/install-manual#step-4---download-the-linux-kernel-update-package) から「Linux カーネル更新プログラム パッケージ」をダウンロード・インストールして PC の再起動後、改めて Ubuntu を起動する。
2. `Installing, this may take a few minutes...` と表示されるので少し待つ。
3. しばらく待つと「UNIX username」と「password」の入力を求められるので、下記のように設定する。
   1. UNIX username: ユーザー名。好みのものを入力して Enter キーで送信。
   2. password: パスワード。好みのものを入力して Enter キーで送信。  
   3. もう一度パスワードを入力するように言われるので、もう一度入力して Enter キーで送信。  
   ※ 入力したパスワードは画面上には表示されないので、誤設定に注意してください。  
4. Ubuntu 環境を最新版にアップデートするため、下記のコマンドを入力して送信する。

    ```shell
    > sudo apt update && sudo apt upgrade -y
    ```

5. アップデートが完了したら一旦 Ubuntu ウィンドウを閉じてもう一回起動する。
6. 下記の順序でコマンドを入力して送信し、コマンドが正しく実行されることを確認する。

    ```shell
    > cd     # ホームディレクトリへ移動する。
    > ls -la # カレントディレクトリの内容を表示する。
    ```

## 3. Docker・Docker Compose

仮想環境を構築したり共有したり色々できるすごいやつ。

### 3.1. Docker のインストール

1. 作成した Ubuntu 環境を更新する。

    ```shell
    > sudo apt update && sudo apt upgrade -y
    ```

2. 必要パッケージをインストールする。

    ```shell
    > sudo apt-get install \
        apt-transport-https \
        ca-certificates \
        curl \
        gnupg \
        lsb-release
    ```

3. Dockerの公式GPGキーを追加。

    ```shell
    > curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    ```

4. リポジトリの設定。

    ```shell
    > echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    ```

5. Docker のインストール

    ```shell
    > sudo apt-get update
    > sudo apt-get install docker-ce docker-ce-cli containerd.io
    > docker version
    ```

6. 起動テスト

    ```shell
    sudo docker run hello-world
    ```

   1. 下記のように言われたらDockerが起動していないので……

       ```shell
      > sudo docker run hello-world
      [sudo] password for <<username>>:
      docker: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?.
       ```

   2. Docker が起動中であるか確認し、起動していなければ起動する。

       ```shell
      > sudo service docker status                # 確認
       * Docker is not running

      > sudo service docker start                 # 起動する
       * Starting Docker: docker        [ OK ]

      > sudo service docker status                # こう表示されれば OK
       * Docker is running

      > sudo service docker stop                  # 止める場合はコレ
       * Stopping Docker: docker        [ OK ]
       ```

   3. もう一度 `sudo docker run hello-world` を実行する。

7. 下記のように表示されれば OK 。

    ```shell
    Unable to find image 'hello-world:latest' locally
    latest: Pulling from library/hello-world
    2db29710123e: Pull complete
    Digest: sha256:975f4b14f326b05db86e16de00144f9c12257553bba9484fed41f9b6f2257800
    Status: Downloaded newer image for hello-world:latest

    ...

    Hello from Docker!
    This message shows that your installation appears to be working correctly.
    ```

### 3.2. Docker を sudo 無しでも実行できるようにする

1. 下記を実行する。

    ```shell
    > getent group docker
    > sudo gpasswd -a kenkenpa198 docker
    ```

2. Ubuntu を再起動する。
3. sudo 無しで実行してみる。

    ```shell
    > docker run hello-world
    ```

### 3.3. Docker Compose のインストール

1. curl でインストールする

    ```shell
    > sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    > sudo chmod +x /usr/local/bin/docker-compose
    > docker-compose -v
    ```

## 4. MSSQL with Docker コンテナの稼働

[README.md](README.md) 、[コマンドメモ.md](コマンドメモ.md) を参考に稼働させる。

## 5. Azure Data Studio

1. PowerShell か CMD を開いて、`winget` コマンドでインストールする。

    ```shell
    > winget install Microsoft.AzureDataStudio
    ```

2. MSSQL with Docker コンテナを稼働させておく。

3. 参考サイトをもとに日本語化。
4. `接続の追加` > `接続の詳細` へ下記のように設定。
   1. サーバー: ※1 を参考に設定
   2. 認証の種類: `SQL ログイン`
   3. ユーザー名: `sa`
   4. パスワード: `Test1234`
   5. パスワードを記憶する: チェックする
   6. データベース: `<既定>`
   7. サーバー グループ: `<規定>`
   8. 名前 (省略可能): `好きな名前`

    ```text
    ※1 サーバーの接続アドレスは、下記の手順で調べて入力する。

    1. WSL上で `ip a | grep eth0 | grep inet` を送信
    2.  出力されたアドレスを基に下記のように設定。
    `inet AAA.BB.CCC.DDD/20 brd .....`
    ⇒ `tcp:AAA.BB.CCC.DDD, 1433`
    ```

5. `接続` ボタンをクリック。
6. いろいろ表示されたら完了。クエリを実行してみたりしてみる。

## 6. 参考サイト

- WSL2（Ubuntu）
  - [WSL のインストール | Microsoft Docs](https://docs.microsoft.com/ja-jp/windows/wsl/install)
  - [Windows Terminal + WSL 2 + Homebrew + Zsh - Qiita](https://qiita.com/okayurisotto/items/36f6f9df499a74e62bff)
  - [windows10でVSCode+WSL2(Ubuntu)+Docker Desktopの開発環境を作る](https://zenn.dev/ivgtr/scraps/92e14f80683be9)
- Docker・Docker Compose
  - [Install Docker Engine on Ubuntu | Docker Documentation](https://docs.docker.com/engine/install/ubuntu/)
  - [ubuntu20.04にDockerとdocker-composeをインストールする](https://zenn.dev/k_neko3/articles/76340d2db1f43d)
- Azure Data Studio
  - [Azure Data Studio - 日本語化する方法](https://www.curict.com/item/48/48b33f5.html)
  - [WSL2上のDockerでSQL Server実行してSSMSで繋ぐまで - YOMON8.NET](https://yomon.hatenablog.com/entry/2020/03/wsl2_mssql_ssms)
